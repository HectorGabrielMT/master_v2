<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER - Gestión de Correo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .contact-card { 
            transition: all 0.2s ease; 
            cursor: pointer;
        }
        .contact-card:hover { 
            transform: translateY(-2px);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .contact-card:active {
            transform: translateY(0);
            background-color: #dbeafe;
        }
        
        .section-header {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 10;
            padding: 8px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex items-center justify-center md:p-4 p-0">

    <div class="w-full max-w-7xl bg-white shadow-2xl md:rounded-2xl overflow-hidden flex flex-col md:flex-row border border-gray-200 h-full md:h-[92vh]">
        
        <div class="flex-grow flex flex-col border-r border-gray-100 min-w-0 bg-white">
            <div class="bg-[#1e293b] text-white px-6 py-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-500/20 rounded-lg">
                        <i data-lucide="send" class="w-5 h-5 text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="text-sm font-semibold tracking-wide">Redactar Notificación</h2>
                        <p class="text-[10px] text-slate-400 uppercase font-medium">
                            ID Notificación: {{ notificacion_id|default:"Nuevo" }}
                        </p>
                    </div>
                </div>
            </div>

<form id="emailForm" class="flex flex-col flex-grow overflow-hidden">
    {% csrf_token %}
    
    {% if ficha_pdf_data %}
        <input type="hidden" id="fichaPdfData" name="ficha_pdf_data" value="{{ ficha_pdf_data }}">
        <input type="hidden" id="fichaNombre" name="ficha_nombre" value="{{ ficha_nombre }}">
    {% endif %}
    
    <div class="px-6 border-b border-gray-50 bg-slate-50/50 shrink-0">
        <div class="flex items-center border-b border-gray-200 py-3">
            <span class="text-slate-500 text-xs font-semibold w-16 shrink-0">PARA</span>
            <input type="text" name="para" id="input-para" value="{{ para|join:', ' }}" required
                   class="flex-grow bg-transparent outline-none text-sm px-2 font-medium text-slate-700"
                   placeholder="ejemplo@correo.com">
            <div class="flex gap-3 text-[10px] font-bold text-slate-400">
                <button type="button" onclick="toggleField('ccField')" class="hover:text-blue-600 transition-colors">CC</button>
                <button type="button" onclick="toggleField('ccoField')" class="hover:text-blue-600 transition-colors">CCO</button>
            </div>
        </div>

        <div id="ccField" class="{% if not cc %}hidden{% endif %} flex items-center border-b border-gray-200 py-3">
            <span class="text-slate-500 text-xs font-semibold w-16 shrink-0">CC</span>
            <input type="text" name="cc" id="input-cc" value="{{ cc|join:', ' }}" 
                   class="flex-grow bg-transparent outline-none text-sm px-2 text-slate-700"
                   placeholder="Con copia a...">
        </div>

        <div id="ccoField" class="{% if not cco %}hidden{% endif %} flex items-center border-b border-gray-200 py-3">
            <span class="text-slate-500 text-xs font-semibold w-16 shrink-0">CCO</span>
            <input type="text" name="cco" id="input-cco" value="{{ cco|join:', ' }}" 
                   class="flex-grow bg-transparent outline-none text-sm px-2 text-slate-700"
                   placeholder="Copia oculta...">
        </div>

        <div class="flex items-center py-4">
            <input type="text" name="asunto" value="{{ asunto }}" required placeholder="Asunto del correo"
                   class="w-full bg-transparent outline-none text-lg font-bold text-slate-800 placeholder:text-slate-300">
        </div>
    </div>

    <div class="flex-grow overflow-y-auto custom-scroll px-6">
        <textarea name="cuerpo" placeholder="Escriba el contenido aquí..."
                  class="w-full py-6 outline-none text-[15px] resize-none text-slate-600 leading-relaxed min-h-[300px] block">{{ cuerpo }}</textarea>
        
        <div id="previewContainer" class="pb-10 pt-4 flex flex-wrap gap-3 border-t border-slate-100"></div>
    </div>

    <div class="px-6 py-4 flex items-center justify-between bg-white border-t border-slate-100 shrink-0">
        <div class="flex items-center gap-4">
            <button type="submit" id="submitBtn" 
                      class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-10 py-2.5 rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center gap-2">
                <span>Enviar Correo</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>

            <div class="relative group">
                <input type="file" id="fileSelector" multiple class="absolute inset-0 opacity-0 cursor-pointer z-10">
                <button type="button" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>
</form>
        </div>

        <div class="w-full md:w-80 bg-slate-50/80 flex flex-col border-t md:border-t-0 shrink-0">
            <div class="p-5 border-b border-slate-200">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="users" class="w-4 h-4 text-blue-600"></i>
                    <h3 class="font-bold text-xs text-slate-500 uppercase tracking-widest">Contactos del CCPP</h3>
                </div>
                
                <div class="mb-3 p-2 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-[10px] text-blue-700 font-semibold">
                        <i data-lucide="building" class="w-3 h-3 inline mr-1"></i>
                        {{ ccpp_actual.nombre }}
                    </p>
                </div>
                
                <div class="relative">
                    <input type="text" id="buscarContacto" onkeyup="filtrarContactos()" 
                           placeholder="Buscar correo..." 
                           class="w-full pl-9 pr-4 py-2 text-xs border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500/20">
                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scroll p-4" id="listaContactosUnica">
                <div class="grupo-contacto mb-6" id="grupoPara">
                    <div class="section-header">
                        <span class="text-[10px] font-bold text-blue-600 uppercase tracking-tighter">Destinatarios (Para)</span>
                    </div>
                    {% for email in contactos_disponibles.para %}
                        <div onclick="agregarEmail('para', '{{ email }}')" 
                             class="contact-card bg-white border border-slate-100 rounded-xl p-3 mb-2 shadow-sm hover:shadow-md">
                            <span class="text-[11px] font-medium text-slate-700 block truncate email-val">{{ email }}</span>
                        </div>
                    {% endfor %}
                </div>

                <div class="grupo-contacto mb-6" id="grupoCc">
                    <div class="section-header">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">En Copia (Cc)</span>
                    </div>
                    {% for email in contactos_disponibles.cc %}
                        <div onclick="agregarEmail('cc', '{{ email }}')" 
                             class="contact-card bg-white border border-slate-100 rounded-xl p-3 mb-2 shadow-sm hover:shadow-md">
                            <span class="text-[11px] font-medium text-slate-700 block truncate email-val">{{ email }}</span>
                        </div>
                    {% endfor %}
                </div>

                <div class="grupo-contacto mb-6" id="grupoCco">
                    <div class="section-header">
                        <span class="text-[10px] font-bold text-purple-600 uppercase tracking-tighter">Copia Oculta (Cco)</span>
                    </div>
                    {% for email in contactos_disponibles.cco %}
                        <div onclick="agregarEmail('cco', '{{ email }}')" 
                             class="contact-card bg-white border border-slate-100 rounded-xl p-3 mb-2 shadow-sm hover:shadow-md">
                            <span class="text-[11px] font-medium text-slate-700 block truncate email-val">{{ email }}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let archivosAcumulados = [];
        const selectorArchivos = document.getElementById('fileSelector');
        const contenedorVistaPrevia = document.getElementById('previewContainer');

        // 1. Alternar visibilidad de campos y LIMPIAR SI SE OCULTA
        function toggleField(id) {
            const campo = document.getElementById(id);
            campo.classList.toggle('hidden');
            
            // Si el campo se ocultó, vaciamos su input para que no se envíe información
            if (campo.classList.contains('hidden')) {
                const input = campo.querySelector('input');
                if (input) input.value = "";
            }
        }

        // 2. Filtrado de contactos
        function filtrarContactos() {
            const filtro = document.getElementById('buscarContacto').value.toLowerCase();
            const tarjetas = document.querySelectorAll('.contact-card');
            
            tarjetas.forEach(t => {
                const email = t.querySelector('.email-val').textContent.toLowerCase();
                t.style.display = email.includes(filtro) ? "block" : "none";
            });

            document.querySelectorAll('.grupo-contacto').forEach(grupo => {
                const visibles = grupo.querySelectorAll('.contact-card[style="display: block;"]').length;
                grupo.style.display = (visibles === 0 && filtro !== "") ? "none" : "block";
            });
        }

        // 3. Agregar email desde lista lateral
        function agregarEmail(destino, email) {
            const input = document.getElementById(`input-${destino}`);
            const campo = document.getElementById(`${destino}Field`);
            
            if (campo) campo.classList.remove('hidden');

            let emails = input.value.split(',').map(e => e.trim()).filter(e => e !== "");
            
            if (!emails.includes(email)) {
                emails.push(email);
                input.value = emails.join(', ');
                
                const tarjeta = event.currentTarget;
                const originalBg = tarjeta.style.backgroundColor;
                tarjeta.style.backgroundColor = "#dcfce7";
                setTimeout(() => { tarjeta.style.backgroundColor = originalBg; }, 300);
            }
            input.focus();
        }

        // 4. Gestión de Archivos (Render con link para abrir)
        function renderizarArchivos() {
            contenedorVistaPrevia.innerHTML = "";
            archivosAcumulados.forEach((archivo, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden text-xs';
                div.innerHTML = `
                    <a href="${archivo.urlVistaPrevia}" target="_blank" 
                       class="px-3 py-2 truncate max-w-[150px] font-medium text-blue-600 hover:bg-blue-50 transition-colors"
                       title="Clic para abrir">
                        ${archivo.name}
                    </a>
                    <button type="button" onclick="eliminarArchivo(${i})" class="px-2 py-2 text-red-500 hover:bg-red-50 border-l border-slate-200">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>`;
                contenedorVistaPrevia.appendChild(div);
            });
            lucide.createIcons();
        }

        function eliminarArchivo(i) {
            URL.revokeObjectURL(archivosAcumulados[i].urlVistaPrevia);
            archivosAcumulados.splice(i, 1);
            renderizarArchivos();
        }

        // 5. Carga inicial de archivos (Ficha del servidor)
        document.addEventListener('DOMContentLoaded', function() {
            const datosFicha = document.getElementById('fichaPdfData');
            const nombreFicha = document.getElementById('fichaNombre');
            if (datosFicha && nombreFicha) {
                const bstr = atob(datosFicha.value);
                let n = bstr.length, u8arr = new Uint8Array(n);
                while(n--) u8arr[n] = bstr.charCodeAt(n);
                const archivoPdf = new File([u8arr], nombreFicha.value, {type: 'application/pdf'});
                archivoPdf.urlVistaPrevia = URL.createObjectURL(archivoPdf);
                archivosAcumulados.push(archivoPdf);
                renderizarArchivos();
            }
        });

        selectorArchivos.addEventListener('change', function(e) {
            Array.from(e.target.files).forEach(archivo => {
                archivo.urlVistaPrevia = URL.createObjectURL(archivo);
                archivosAcumulados.push(archivo);
            });
            renderizarArchivos();
            this.value = ""; 
        });

        // 6. Envío del Formulario
        document.getElementById('emailForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = "Enviando...";

            const formData = new FormData(this);
            archivosAcumulados.forEach(a => {
                // Solo adjuntamos los archivos nuevos (la ficha ya se procesa por ID o base64 en backend usualmente)
                if (!a.name.includes('Ficha_')) formData.append('adjuntos_finales', a);
            });

            try {
                const response = await fetch(`${window.location.pathname}${window.location.search}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const result = await response.json();
                if (result.status === 'ok') {
                    window.location.href = "{% url 'correo_enviado' %}";
                } else {
                    alert("Error: " + result.message);
                    btn.disabled = false;
                    btn.innerHTML = "Enviar Correo";
                }
            } catch (error) {
                alert("Error de red.");
                btn.disabled = false;
                btn.innerHTML = "Enviar Correo";
            }
        };
    </script>
</body>
</html>